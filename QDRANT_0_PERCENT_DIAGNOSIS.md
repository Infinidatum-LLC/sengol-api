# Qdrant 0% Relevance Score - Root Cause Analysis

**Date**: 2025-11-11
**Status**: ðŸ”´ CRITICAL ISSUE IDENTIFIED
**Impact**: ALL question generation showing 0% relevance

## Executive Summary

The Sengol API is showing **0% relevance scores** for all dynamically generated risk questions. Root cause investigation reveals that the **Qdrant vector database at `10.128.0.2:6333` is unreachable**.

## Root Cause

```
âŒ Connect Timeout Error: Cannot connect to Qdrant VM at 10.128.0.2:6333
```

### Technical Details

**Connection Test Results**:
```
[Qdrant] Connecting to Qdrant at 10.128.0.2:6333
âŒ Health check: FAILED
ConnectTimeoutError: Connect Timeout Error
  code: 'UND_ERR_CONNECT_TIMEOUT'
```

**Implications**:
1. **Vector search fails silently** - No incidents are returned
2. **Relevance score calculation**: `0 incidents â†’ 0% relevance`
3. **Question generation continues** - Questions are still generated by GPT-4o BUT without evidence-based weighting
4. **User Experience**: Questions appear generic, not tailored to historical incidents

## Architecture Context

### Current System Design

```
User Query â†’ Embedding (OpenAI) â†’ Qdrant Vector Search â†’ Incident Matches â†’
Evidence-based Questions (with weights, examples, statistics)
```

### When Qdrant is Down

```
User Query â†’ Embedding (OpenAI) â†’ âŒ Qdrant (TIMEOUT) â†’ No incidents â†’
Generic Questions (0% relevance, no weights, no evidence)
```

## Why This Happened

### Possible Causes

1. **VM is stopped/terminated**
   - GCP may have auto-stopped the VM to save costs
   - Check: `gcloud compute instances list --filter="name=sengol-vector-db"`

2. **Network/Firewall Issue**
   - Internal IP `10.128.0.2` may have changed
   - Firewall rules may have been modified
   - VPC peering may be broken

3. **Qdrant service crashed**
   - Qdrant Docker container may have stopped
   - Out of memory or disk space
   - Check: SSH into VM and run `docker ps | grep qdrant`

4. **Resource Exhaustion**
   - VM ran out of memory/disk
   - Qdrant process killed by OOM killer

## Impact Analysis

### What's Broken

âœ… **Still Working**:
- API endpoint `/api/review/:id/generate-questions` responds
- OpenAI GPT-4o question generation
- Database queries (PostgreSQL)
- Frontend caching

âŒ **Not Working**:
- Vector similarity search
- Evidence-based question weighting
- Historical incident statistics
- Industry benchmarking
- MFA/Backup/IR Plan adoption calculations
- Cost savings analysis

### Business Impact

- **Question Quality**: Reduced from evidence-based to generic LLM output
- **Competitive Advantage**: Lost differentiator (historical incident data)
- **Client Trust**: Cannot show evidence/examples for questions
- **Compliance**: Cannot demonstrate due diligence for audit trails

## Immediate Next Steps

### 1. Verify VM Status (PRIORITY 1)

You need to run:
```bash
gcloud auth login

gcloud compute instances list \
  --project=elite-striker-477619-p8 \
  --filter="name=sengol-vector-db" \
  --format="table(name,zone,status,machineType,networkInterfaces[0].networkIP)"
```

**Expected Output**:
- Status: `RUNNING` â† If not, VM is stopped
- Internal IP: `10.128.0.2` â† If different, update `QDRANT_HOST` env var

### 2. Start VM if Stopped

```bash
gcloud compute instances start sengol-vector-db \
  --zone=us-central1-a \
  --project=elite-striker-477619-p8
```

Wait 30-60 seconds for Qdrant to start, then re-test.

### 3. Test Connection Again

```bash
cd /Users/durai/Documents/GitHub/sengol-api
npx tsx test-qdrant-diagnosis.ts
```

### 4. If VM is Running but Qdrant is Down

SSH into the VM:
```bash
gcloud compute ssh sengol-vector-db \
  --zone=us-central1-a \
  --project=elite-striker-477619-p8
```

Check Qdrant status:
```bash
docker ps | grep qdrant
docker logs qdrant-server 2>&1 | tail -50
```

Restart Qdrant if needed:
```bash
docker restart qdrant-server
```

## Long-term Solutions

### Option 1: Keep Current Architecture (Lowest Cost)

**Pros**:
- $96/month for VM + Qdrant
- Full control over data
- Fast vector search (< 500ms)

**Cons**:
- Manual VM management
- Single point of failure
- No auto-scaling

**Required Actions**:
1. Set up VM auto-restart policy
2. Configure health monitoring alerts
3. Set up automated backups
4. Document disaster recovery procedures

### Option 2: Migrate to Managed Qdrant Cloud

**Pros**:
- Managed service (no VM maintenance)
- Auto-scaling
- Built-in backups
- SLA guarantees

**Cons**:
- Higher cost (~$200-400/month)
- Less control over infrastructure

### Option 3: Migrate to Google Vertex AI Vector Search

**Pros**:
- Fully managed by Google
- Auto-scaling
- Integrated with Google Cloud
- No VM maintenance

**Cons**:
- Expensive (estimated $500-1000/month)
- Vendor lock-in
- Less flexibility

### Recommendation

**Keep Qdrant self-hosted** but implement:
1. **Health monitoring** - Set up GCP alerting for VM downtime
2. **Auto-restart** - Configure VM to auto-restart on failure
3. **API fallback** - Gracefully degrade to GPT-4o-only mode when Qdrant is down
4. **Backup strategy** - Regular Qdrant snapshots to GCS

## Code Changes Needed (Optional Enhancement)

### Graceful Degradation

Currently, the system silently fails when Qdrant is down. We should add:

```typescript
// In incident-search.ts
export async function findSimilarIncidents(...) {
  try {
    const results = await qdrantSearch(query, options)
    return results
  } catch (error) {
    console.error('[QDRANT] Vector search failed, degrading gracefully:', error)

    // Emit metric/alert
    sendAlert({
      severity: 'critical',
      message: 'Qdrant vector database is unreachable',
      timestamp: new Date(),
    })

    // Return empty array instead of throwing
    return []
  }
}
```

### Health Check Endpoint

Add to `/health/detailed` endpoint:

```typescript
const qdrantHealth = await checkQdrantHealth()

return {
  status: 'ok',
  checks: {
    database: dbHealth,
    qdrant: qdrantHealth, // â† Add this
  }
}
```

## Test Script

A diagnosis script has been created at:
- `/Users/durai/Documents/GitHub/sengol-api/test-qdrant-diagnosis.ts`

Run with:
```bash
npx tsx test-qdrant-diagnosis.ts
```

## Files Analyzed

1. **src/lib/qdrant-client.ts** (lines 1-252)
   - Qdrant connection: `10.128.0.2:6333`
   - Collection: `sengol_incidents_full`
   - Embedding model: `text-embedding-3-small` (1536 dimensions)

2. **src/services/incident-search.ts** (lines 1-150)
   - 3-tier caching (L1 memory, L2 Redis, L3 Qdrant)
   - Min similarity: 0.3 (already lowered from 0.7)

3. **src/services/dynamic-question-generator.ts** (lines 1100-1200)
   - Relevance score: `sum(similarity) / count`
   - When count = 0 â†’ relevance = 0%

## Summary

**The 0% relevance issue is NOT a code bug or data embedding problem.**

It's an **infrastructure issue** - the Qdrant VM is unreachable. Once the VM is started and Qdrant is confirmed running, the system will immediately resume normal operation with evidence-based question generation.

**No re-crawling or re-embedding is required** - the data in Qdrant (if it exists) is still valid. We just need to restore connectivity to the VM.

---

**Next Action**: Run `gcloud auth login` and check VM status.
